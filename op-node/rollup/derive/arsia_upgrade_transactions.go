package derive

import (
	"bytes"
	"fmt"
	"math/big"

	"github.com/ethereum-optimism/optimism/op-service/predeploys"
	"github.com/ethereum-optimism/optimism/op-service/solabi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
)

const UpgradeToFuncSignature = "upgradeTo(address)"

var (
	// L1Block Parameters for Arsia
	deployArsiaL1BlockSource      = UpgradeDepositSource{Intent: "Arsia: L1 Block Deployment"}
	updateArsiaL1BlockProxySource = UpgradeDepositSource{Intent: "Arsia: L1 Block Proxy Update"}
	L1BlockArsiaDeployerAddress   = common.HexToAddress("0x4210000000000000000000000000000000000000")
	arsiaL1BlockAddress           = crypto.CreateAddress(L1BlockArsiaDeployerAddress, 0)

	// Gas Price Oracle Parameters for Arsia
	deployArsiaGasPriceOracleSource      = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Deployment"}
	updateArsiaGasPriceOracleProxySource = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Proxy Update"}
	GasPriceOracleArsiaDeployerAddress   = common.HexToAddress("0x4210000000000000000000000000000000000001")
	arsiaGasPriceOracleAddress           = crypto.CreateAddress(GasPriceOracleArsiaDeployerAddress, 0)

	// Enable Arsia Parameters
	enableArsiaSource = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Set Arsia"}
	enableArsiaInput  = crypto.Keccak256([]byte("setArsia()"))[:4]

	UpgradeToFuncBytes4 = crypto.Keccak256([]byte(UpgradeToFuncSignature))[:4]

	// Bytecodes for Arsia
	// Run:
	// cat forge-artifacts/L1Block.sol/L1Block.json | jq -r '.bytecode.object' > l1block_bytecode.txt
	// cat forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json | jq -r '.bytecode.object' > gpo_bytecode.txt
	l1BlockArsiaDeploymentBytecode        = common.FromHex("0x60e060405234801561001057600080fd5b506001608081905260a052600060c05260805160a05160c05161090661004f600039600061044101526000610418015260006103ef01526109066000f3fe608060405234801561001057600080fd5b506004361061011b5760003560e01c806368d5dca6116100b2578063b80777ea11610081578063e591b28211610066578063e591b2821461026b578063e81b2c6d1461028d578063f82061401461029657600080fd5b8063b80777ea1461022b578063c59859181461024b57600080fd5b806368d5dca6146101e95780638381f58a146102055780638b239f73146102195780639e8c49661461022257600080fd5b80634d5d9a2a116100ee5780634d5d9a2a1461018657806354fd4d50146101b75780635cf24969146101cc57806364ca23ef146101d557600080fd5b8063015d8eb91461012057806309bd5a601461013557806316d3bc7f1461015157806349e723831461017e575b600080fd5b61013361012e366004610645565b61029f565b005b61013e60025481565b6040519081526020015b60405180910390f35b6008546101659067ffffffffffffffff1681565b60405167ffffffffffffffff9091168152602001610148565b6101336103de565b6008546101a29068010000000000000000900463ffffffff1681565b60405163ffffffff9091168152602001610148565b6101bf6103e8565b60405161014891906106e7565b61013e60015481565b6003546101659067ffffffffffffffff1681565b6003546101a29068010000000000000000900463ffffffff1681565b6000546101659067ffffffffffffffff1681565b61013e60055481565b61013e60065481565b6000546101659068010000000000000000900467ffffffffffffffff1681565b6003546101a2906c01000000000000000000000000900463ffffffff1681565b60405173deaddeaddeaddeaddeaddeaddeaddeaddead00018152602001610148565b61013e60045481565b61013e60075481565b3373deaddeaddeaddeaddeaddeaddeaddeaddead000114610346576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603b60248201527f4c31426c6f636b3a206f6e6c7920746865206465706f7369746f72206163636f60448201527f756e742063616e20736574204c3120626c6f636b2076616c7565730000000000606482015260840160405180910390fd5b6000805467ffffffffffffffff98891668010000000000000000027fffffffffffffffffffffffffffffffff00000000000000000000000000000000909116998916999099179890981790975560019490945560029290925560038054919094167fffffffffffffffffffffffffffffffffffffffffffffffff00000000000000009190911617909255600491909155600555600655565b6103e661048b565b565b60606104137f00000000000000000000000000000000000000000000000000000000000000006104eb565b61043c7f00000000000000000000000000000000000000000000000000000000000000006104eb565b6104657f00000000000000000000000000000000000000000000000000000000000000006104eb565b60405160200161047793929190610738565b604051602081830303815290604052905090565b73deaddeaddeaddeaddeaddeaddeaddeaddead00013381146104b557633cc50b456000526004601cfd5b60043560801c60035560143560801c60005560243560015560443560075560643560025560843560045560a43560a01c60085550565b60608160000361052e57505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b81156105585780610542816107dd565b91506105519050600a83610844565b9150610532565b60008167ffffffffffffffff81111561057357610573610858565b6040519080825280601f01601f19166020018201604052801561059d576020820181803683370190505b5090505b8415610620576105b2600183610887565b91506105bf600a8661089e565b6105ca9060306108b2565b60f81b8183815181106105df576105df6108ca565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350610619600a86610844565b94506105a1565b949350505050565b803567ffffffffffffffff8116811461064057600080fd5b919050565b600080600080600080600080610100898b03121561066257600080fd5b61066b89610628565b975061067960208a01610628565b9650604089013595506060890135945061069560808a01610628565b979a969950949793969560a0850135955060c08501359460e001359350915050565b60005b838110156106d25781810151838201526020016106ba565b838111156106e1576000848401525b50505050565b60208152600082518060208401526107068160408501602087016106b7565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169190910160400192915050565b6000845161074a8184602089016106b7565b80830190507f2e000000000000000000000000000000000000000000000000000000000000008082528551610786816001850160208a016106b7565b600192019182015283516107a18160028401602088016106b7565b0160020195945050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361080e5761080e6107ae565b5060010190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b60008261085357610853610815565b500490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600082821015610899576108996107ae565b500390565b6000826108ad576108ad610815565b500690565b600082198211156108c5576108c56107ae565b500190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea164736f6c634300080f000a")
	gasPriceOracleArsiaDeploymentBytecode = common.FromHex("0x60e060405234801561001057600080fd5b506001608081905260a052600060c05260805160a05160c05161158061004f60003960006106960152600061066d0152600061064401526115806000f3fe608060405234801561001057600080fd5b50600436106101985760003560e01c806368d5dca6116100e3578063de26c4a11161008c578063f45e65d811610066578063f45e65d814610357578063f82061401461035f578063fe173b97146102d357600080fd5b8063de26c4a11461031e578063e38e91f914610331578063f2fde38b1461034457600080fd5b80638f018a7b116100bd5780638f018a7b146102f9578063b3ab15fb14610303578063c59859181461031657600080fd5b806368d5dca6146102cb5780636ef25c3a146102d35780638da5cb5b146102d957600080fd5b8063313ce56711610145578063519b4bd31161011f578063519b4bd31461026957806354fd4d5014610271578063570ca7351461028657600080fd5b8063313ce5671461023257806349948e0e146102395780634d5d9a2a1461024c57600080fd5b80631e2b6e7b116101765780631e2b6e7b146101e2578063275aedd2146102175780632e0f26251461022a57600080fd5b806306f837d31461019d5780630c18c162146101b957806316d3bc7f146101c1575b600080fd5b6101a660005481565b6040519081526020015b60405180910390f35b6101a6610367565b6101c96103f1565b60405167ffffffffffffffff90911681526020016101b0565b6002546102079074010000000000000000000000000000000000000000900460ff1681565b60405190151581526020016101b0565b6101a6610225366004611015565b610476565b6101a6600681565b60066101a6565b6101a661024736600461105d565b61051f565b610254610557565b60405163ffffffff90911681526020016101b0565b6101a66105dc565b61027961063d565b6040516101b0919061115c565b6002546102a69073ffffffffffffffffffffffffffffffffffffffff1681565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020016101b0565b6102546106e0565b486101a6565b6001546102a69073ffffffffffffffffffffffffffffffffffffffff1681565b610301610741565b005b6103016103113660046111ad565b6108d4565b6102546109cc565b6101a661032c36600461105d565b610a2d565b61030161033f366004611015565b610a54565b6103016103523660046111ad565b610b0c565b6101a6610c81565b6101a6610ce2565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16638b239f736040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c8573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103ec91906111e3565b905090565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff166316d3bc7f6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610452573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103ec91906111fc565b60025460009074010000000000000000000000000000000000000000900460ff166104a357506000919050565b610519620f42406104f1846104b6610557565b63ffffffff167fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821583830293840490921491909117011790565b6104fb9190611284565b6105036103f1565b67ffffffffffffffff1681019081106000031790565b92915050565b60025460009074010000000000000000000000000000000000000000900460ff161561054e5761051982610d43565b61051982610de7565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16634d5d9a2a6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105b8573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103ec9190611298565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16635cf249696040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c8573d6000803e3d6000fd5b60606106687f0000000000000000000000000000000000000000000000000000000000000000610e48565b6106917f0000000000000000000000000000000000000000000000000000000000000000610e48565b6106ba7f0000000000000000000000000000000000000000000000000000000000000000610e48565b6040516020016106cc939291906112be565b604051602081830303815290604052905090565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff166368d5dca66040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105b8573d6000803e3d6000fd5b3373deaddeaddeaddeaddeaddeaddeaddeaddead0001146107e9576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603f60248201527f47617350726963654f7261636c653a206f6e6c7920746865206465706f73697460448201527f6f72206163636f756e742063616e20736574206973417273696120666c61670060648201526084015b60405180910390fd5b60025474010000000000000000000000000000000000000000900460ff1615610893576040517f08c379a0000000000000000000000000000000000000000000000000000000008152602060048201526024808201527f47617350726963654f7261636c653a20417273696120616c726561647920616360448201527f746976650000000000000000000000000000000000000000000000000000000060648201526084016107e0565b600280547fffffffffffffffffffffff00ffffffffffffffffffffffffffffffffffffffff1674010000000000000000000000000000000000000000179055565b60015473ffffffffffffffffffffffffffffffffffffffff163314610955576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f43616c6c6572206973206e6f7420746865206f776e657200000000000000000060448201526064016107e0565b6002805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907ffbe5b6cbafb274f445d7fed869dc77a838d8243a22c460de156560e8857cad0390600090a35050565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff1663c59859186040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105b8573d6000803e3d6000fd5b600080610a3983610f85565b9050610a43610367565b610a4d9082611334565b9392505050565b60025473ffffffffffffffffffffffffffffffffffffffff163314610ad5576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601a60248201527f43616c6c6572206973206e6f7420746865206f70657261746f7200000000000060448201526064016107e0565b600080548282556040519091839183917f5d6ae9db2d6725497bed0302a8212c0db5fdb3bd7d14f188a83b5589089caafd91a35050565b60015473ffffffffffffffffffffffffffffffffffffffff163314610b8d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f43616c6c6572206973206e6f7420746865206f776e657200000000000000000060448201526064016107e0565b73ffffffffffffffffffffffffffffffffffffffff8116610c0a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601d60248201527f6e6577206f776e657220697320746865207a65726f206164647265737300000060448201526064016107e0565b6001805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16639e8c49666040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c8573d6000803e3d6000fd5b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff1663f82061406040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c8573d6000803e3d6000fd5b600080610d4f83610f85565b90506000610d5b6105dc565b610d636109cc565b610d6e90601061134c565b63ffffffff16610d7e9190611378565b90506000610d8a610ce2565b610d926106e0565b63ffffffff16610da29190611378565b90506000610db08284611334565b610dba9085611378565b9050610dc86006600a6114d5565b610dd3906010611378565b610ddd9082611284565b9695505050505050565b600080610df383610a2d565b90506000610dff6105dc565b610e099083611378565b90506000610e196006600a6114d5565b90506000610e25610c81565b610e2f9084611378565b90506000610e3d8383611284565b979650505050505050565b606081600003610e8b57505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b8115610eb55780610e9f816114e1565b9150610eae9050600a83611284565b9150610e8f565b60008167ffffffffffffffff811115610ed057610ed061102e565b6040519080825280601f01601f191660200182016040528015610efa576020820181803683370190505b5090505b8415610f7d57610f0f600183611519565b9150610f1c600a86611530565b610f27906030611334565b60f81b818381518110610f3c57610f3c611544565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350610f76600a86611284565b9450610efe565b949350505050565b80516000908190815b8181101561100857848181518110610fa857610fa8611544565b01602001517fff0000000000000000000000000000000000000000000000000000000000000016600003610fe857610fe1600484611334565b9250610ff6565b610ff3601084611334565b92505b80611000816114e1565b915050610f8e565b50610f7d82610440611334565b60006020828403121561102757600080fd5b5035919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60006020828403121561106f57600080fd5b813567ffffffffffffffff8082111561108757600080fd5b818401915084601f83011261109b57600080fd5b8135818111156110ad576110ad61102e565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f011681019083821181831017156110f3576110f361102e565b8160405282815287602084870101111561110c57600080fd5b826020860160208301376000928101602001929092525095945050505050565b60005b8381101561114757818101518382015260200161112f565b83811115611156576000848401525b50505050565b602081526000825180602084015261117b81604085016020870161112c565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169190910160400192915050565b6000602082840312156111bf57600080fd5b813573ffffffffffffffffffffffffffffffffffffffff81168114610a4d57600080fd5b6000602082840312156111f557600080fd5b5051919050565b60006020828403121561120e57600080fd5b815167ffffffffffffffff81168114610a4d57600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60008261129357611293611226565b500490565b6000602082840312156112aa57600080fd5b815163ffffffff81168114610a4d57600080fd5b600084516112d081846020890161112c565b80830190507f2e00000000000000000000000000000000000000000000000000000000000000808252855161130c816001850160208a0161112c565b6001920191820152835161132781600284016020880161112c565b0160020195945050505050565b6000821982111561134757611347611255565b500190565b600063ffffffff8083168185168183048111821515161561136f5761136f611255565b02949350505050565b6000817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516156113b0576113b0611255565b500290565b600181815b8085111561140e57817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048211156113f4576113f4611255565b8085161561140157918102915b93841c93908002906113ba565b509250929050565b60008261142557506001610519565b8161143257506000610519565b816001811461144857600281146114525761146e565b6001915050610519565b60ff84111561146357611463611255565b50506001821b610519565b5060208310610133831016604e8410600b8410161715611491575081810a610519565b61149b83836113b5565b807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048211156114cd576114cd611255565b029392505050565b6000610a4d8383611416565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361151257611512611255565b5060010190565b60008282101561152b5761152b611255565b500390565b60008261153f5761153f611226565b500690565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea164736f6c634300080f000a")
)

// ArsiaNetworkUpgradeTransactions returns the upgrade transactions for the Arsia network upgrade.
// The Arsia upgrade introduces operator fees and updates the L1 data fee calculation model.
func MantleArsiaNetworkUpgradeTransactions() ([]hexutil.Bytes, error) {
	upgradeTxns := make([]hexutil.Bytes, 0, 5)

	// 1. Deploy new L1Block implementation with operator fee support
	deployL1BlockTransaction, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaL1BlockSource.SourceHash(),
		From:                L1BlockArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 500_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                l1BlockArsiaDeploymentBytecode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployL1BlockTransaction)

	// 2. Deploy new GasPriceOracle implementation with Arsia fee calculation
	deployGasPriceOracle, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaGasPriceOracleSource.SourceHash(),
		From:                GasPriceOracleArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 1_200_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                gasPriceOracleArsiaDeploymentBytecode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployGasPriceOracle)

	// 3. Upgrade L1Block proxy to new implementation
	updateL1BlockProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaL1BlockProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.L1BlockAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaL1BlockAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateL1BlockProxy)

	// 4. Upgrade GasPriceOracle proxy to new implementation
	updateGasPriceOracleProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaGasPriceOracleProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.GasPriceOracleAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaGasPriceOracleAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateGasPriceOracleProxy)

	// 5. Enable Arsia mode in GasPriceOracle
	enableArsia, err := types.NewTx(&types.DepositTx{
		SourceHash:          enableArsiaSource.SourceHash(),
		From:                L1InfoDepositerAddress,
		To:                  &predeploys.GasPriceOracleAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 100_000,
		IsSystemTransaction: false,
		Data:                enableArsiaInput,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, enableArsia)

	return upgradeTxns, nil
}

func upgradeToCalldata(addr common.Address) []byte {
	buf := bytes.NewBuffer(make([]byte, 0, 4+20))
	if err := solabi.WriteSignature(buf, UpgradeToFuncBytes4); err != nil {
		panic(fmt.Errorf("failed to write upgradeTo signature data: %w", err))
	}
	if err := solabi.WriteAddress(buf, addr); err != nil {
		panic(fmt.Errorf("failed to write upgradeTo address data: %w", err))
	}
	return buf.Bytes()
}

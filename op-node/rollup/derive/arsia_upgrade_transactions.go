package derive

import (
	"bytes"
	"fmt"
	"math/big"

	"github.com/ethereum-optimism/optimism/op-service/predeploys"
	"github.com/ethereum-optimism/optimism/op-service/solabi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
)

const UpgradeToFuncSignature = "upgradeTo(address)"

var (
	// L1Block Parameters for Arsia
	deployArsiaL1BlockSource      = UpgradeDepositSource{Intent: "Arsia: L1 Block Deployment"}
	updateArsiaL1BlockProxySource = UpgradeDepositSource{Intent: "Arsia: L1 Block Proxy Update"}
	L1BlockArsiaDeployerAddress   = common.HexToAddress("0x4250000000000000000000000000000000000000")
	arsiaL1BlockAddress           = crypto.CreateAddress(L1BlockArsiaDeployerAddress, 0)

	// Gas Price Oracle Parameters for Arsia
	deployArsiaGasPriceOracleSource      = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Deployment"}
	updateArsiaGasPriceOracleProxySource = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Proxy Update"}
	GasPriceOracleArsiaDeployerAddress   = common.HexToAddress("0x4250000000000000000000000000000000000001")
	arsiaGasPriceOracleAddress           = crypto.CreateAddress(GasPriceOracleArsiaDeployerAddress, 0)

	// Operator Fee Vault Parameters for Arsia
	deployArsiaOperatorFeeVaultSource      = UpgradeDepositSource{Intent: "Arsia: Operator Fee Vault Deployment"}
	updateArsiaOperatorFeeVaultProxySource = UpgradeDepositSource{Intent: "Arsia: Operator Fee Vault Proxy Update"}
	OperatorFeeVaultArsiaDeployerAddress   = common.HexToAddress("0x4250000000000000000000000000000000000002")
	arsiaOperatorFeeVaultAddress           = crypto.CreateAddress(OperatorFeeVaultArsiaDeployerAddress, 0)

	// Enable Arsia Parameters
	enableArsiaSource = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Set Arsia"}
	enableArsiaInput  = crypto.Keccak256([]byte("setArsia()"))[:4]

	UpgradeToFuncBytes4 = crypto.Keccak256([]byte(UpgradeToFuncSignature))[:4]

	// Bytecodes for Arsia
	// Run:
	// cat forge-artifacts/L1Block.sol/L1Block.json | jq -r '.bytecode.object' > l1block_bytecode.txt
	// cat forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json | jq -r '.bytecode.object' > gpo_bytecode.txt
	// cat forge-artifacts/OperatorFeeVault.sol/OperatorFeeVault.json | | jq -r '.bytecode.object' > ofv_bytecode.txt
	//   And sufix bytecode with constructor arguments 'abi.encode(operator_fee_vault_recipient_address)'
	l1BlockArsiaDeploymentBytecode          = common.FromHex("0x60e060405234801561001057600080fd5b506001608081905260a052600060c05260805160a05160c05161096a61004f600039600061048d015260006104640152600061043b015261096a6000f3fe608060405234801561001057600080fd5b50600436106101365760003560e01c80638381f58a116100b2578063c598591811610081578063e81b2c6d11610066578063e81b2c6d146102a8578063f8206140146102b1578063fe3d5710146102ba57600080fd5b8063c598591814610266578063e591b2821461028657600080fd5b80638381f58a146102205780638b239f73146102345780639e8c49661461023d578063b80777ea1461024657600080fd5b80634d5d9a2a116101095780635cf24969116100ee5780635cf24969146101e757806364ca23ef146101f057806368d5dca61461020457600080fd5b80634d5d9a2a146101a157806354fd4d50146101d257600080fd5b8063015d8eb91461013b57806309bd5a601461015057806316d3bc7f1461016c57806349e7238314610199575b600080fd5b61014e6101493660046106a9565b6102eb565b005b61015960025481565b6040519081526020015b60405180910390f35b6008546101809067ffffffffffffffff1681565b60405167ffffffffffffffff9091168152602001610163565b61014e61042a565b6008546101bd9068010000000000000000900463ffffffff1681565b60405163ffffffff9091168152602001610163565b6101da610434565b604051610163919061074b565b61015960015481565b6003546101809067ffffffffffffffff1681565b6003546101bd9068010000000000000000900463ffffffff1681565b6000546101809067ffffffffffffffff1681565b61015960055481565b61015960065481565b6000546101809068010000000000000000900467ffffffffffffffff1681565b6003546101bd906c01000000000000000000000000900463ffffffff1681565b60405173deaddeaddeaddeaddeaddeaddeaddeaddead00018152602001610163565b61015960045481565b61015960075481565b6008546102d8906c01000000000000000000000000900461ffff1681565b60405161ffff9091168152602001610163565b3373deaddeaddeaddeaddeaddeaddeaddeaddead000114610392576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603b60248201527f4c31426c6f636b3a206f6e6c7920746865206465706f7369746f72206163636f60448201527f756e742063616e20736574204c3120626c6f636b2076616c7565730000000000606482015260840160405180910390fd5b6000805467ffffffffffffffff98891668010000000000000000027fffffffffffffffffffffffffffffffff00000000000000000000000000000000909116998916999099179890981790975560019490945560029290925560038054919094167fffffffffffffffffffffffffffffffffffffffffffffffff00000000000000009190911617909255600491909155600555600655565b6104326104d7565b565b606061045f7f000000000000000000000000000000000000000000000000000000000000000061054f565b6104887f000000000000000000000000000000000000000000000000000000000000000061054f565b6104b17f000000000000000000000000000000000000000000000000000000000000000061054f565b6040516020016104c39392919061079c565b604051602081830303815290604052905090565b73deaddeaddeaddeaddeaddeaddeaddeaddead000133811461050157633cc50b456000526004601cfd5b5060048035608090811c600355601435901c60005560243560015560443560075560643560025560843590556dffff00000000000000000000000060b03560901c1660a43560a01c17600855565b60608160000361059257505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b81156105bc57806105a681610841565b91506105b59050600a836108a8565b9150610596565b60008167ffffffffffffffff8111156105d7576105d76108bc565b6040519080825280601f01601f191660200182016040528015610601576020820181803683370190505b5090505b8415610684576106166001836108eb565b9150610623600a86610902565b61062e906030610916565b60f81b8183815181106106435761064361092e565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535061067d600a866108a8565b9450610605565b949350505050565b803567ffffffffffffffff811681146106a457600080fd5b919050565b600080600080600080600080610100898b0312156106c657600080fd5b6106cf8961068c565b97506106dd60208a0161068c565b965060408901359550606089013594506106f960808a0161068c565b979a969950949793969560a0850135955060c08501359460e001359350915050565b60005b8381101561073657818101518382015260200161071e565b83811115610745576000848401525b50505050565b602081526000825180602084015261076a81604085016020870161071b565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169190910160400192915050565b600084516107ae81846020890161071b565b80830190507f2e0000000000000000000000000000000000000000000000000000000000000080825285516107ea816001850160208a0161071b565b6001920191820152835161080581600284016020880161071b565b0160020195945050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361087257610872610812565b5060010190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000826108b7576108b7610879565b500490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000828210156108fd576108fd610812565b500390565b60008261091157610911610879565b500690565b6000821982111561092957610929610812565b500190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea164736f6c634300080f000a")
	gasPriceOracleArsiaDeploymentBytecode   = common.FromHex("0x60e060405234801561001057600080fd5b506001608081905260a052600060c05260805160a05160c051611c6361004f60003960006107840152600061075b015260006107320152611c636000f3fe608060405234801561001057600080fd5b50600436106101a35760003560e01c806368d5dca6116100ee578063de26c4a111610097578063f2fde38b11610071578063f2fde38b14610362578063f45e65d814610375578063f82061401461037d578063fe173b97146102de57600080fd5b8063de26c4a114610329578063e38e91f91461033c578063f1c7a58b1461034f57600080fd5b80638f018a7b116100c85780638f018a7b14610304578063b3ab15fb1461030e578063c59859181461032157600080fd5b806368d5dca6146102d65780636ef25c3a146102de5780638da5cb5b146102e457600080fd5b8063313ce56711610150578063519b4bd31161012a578063519b4bd31461027457806354fd4d501461027c578063570ca7351461029157600080fd5b8063313ce5671461023d57806349948e0e146102445780634d5d9a2a1461025757600080fd5b80631e2b6e7b116101815780631e2b6e7b146101ed578063275aedd2146102225780632e0f26251461023557600080fd5b806306f837d3146101a85780630c18c162146101c457806316d3bc7f146101cc575b600080fd5b6101b160005481565b6040519081526020015b60405180910390f35b6101b1610385565b6101d461040f565b60405167ffffffffffffffff90911681526020016101bb565b6002546102129074010000000000000000000000000000000000000000900460ff1681565b60405190151581526020016101bb565b6101b16102303660046115c8565b610494565b6101b1600681565b60066101b1565b6101b1610252366004611610565b610607565b61025f610645565b60405163ffffffff90911681526020016101bb565b6101b16106ca565b61028461072b565b6040516101bb919061170f565b6002546102b19073ffffffffffffffffffffffffffffffffffffffff1681565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020016101bb565b61025f6107ce565b486101b1565b6001546102b19073ffffffffffffffffffffffffffffffffffffffff1681565b61030c61082f565b005b61030c61031c366004611760565b6109c2565b61025f610aba565b6101b1610337366004611610565b610b1b565b61030c61034a3660046115c8565b610b9d565b6101b161035d3660046115c8565b610c55565b61030c610370366004611760565b610d3e565b6101b1610eb3565b6101b1610f14565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16638b239f736040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103e6573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061040a9190611796565b905090565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff166316d3bc7f6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610470573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061040a91906117af565b60025460009074010000000000000000000000000000000000000000900460ff166104c157506000919050565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16634d5d9a2a6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610522573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061054691906117d9565b63ffffffff169050600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff166316d3bc7f6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105af573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105d391906117af565b67ffffffffffffffff169050806105ea838661182e565b6105f590606461182e565b6105ff919061186b565b949350505050565b60025460009074010000000000000000000000000000000000000000900460ff161561063c5761063682610f75565b92915050565b61063682610f94565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16634d5d9a2a6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156106a6573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061040a91906117d9565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16635cf249696040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103e6573d6000803e3d6000fd5b60606107567f0000000000000000000000000000000000000000000000000000000000000000610ff5565b61077f7f0000000000000000000000000000000000000000000000000000000000000000610ff5565b6107a87f0000000000000000000000000000000000000000000000000000000000000000610ff5565b6040516020016107ba93929190611883565b604051602081830303815290604052905090565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff166368d5dca66040518163ffffffff1660e01b8152600401602060405180830381865afa1580156106a6573d6000803e3d6000fd5b3373deaddeaddeaddeaddeaddeaddeaddeaddead0001146108d7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603f60248201527f47617350726963654f7261636c653a206f6e6c7920746865206465706f73697460448201527f6f72206163636f756e742063616e20736574206973417273696120666c61670060648201526084015b60405180910390fd5b60025474010000000000000000000000000000000000000000900460ff1615610981576040517f08c379a0000000000000000000000000000000000000000000000000000000008152602060048201526024808201527f47617350726963654f7261636c653a20417273696120616c726561647920616360448201527f746976650000000000000000000000000000000000000000000000000000000060648201526084016108ce565b600280547fffffffffffffffffffffff00ffffffffffffffffffffffffffffffffffffffff1674010000000000000000000000000000000000000000179055565b60015473ffffffffffffffffffffffffffffffffffffffff163314610a43576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f43616c6c6572206973206e6f7420746865206f776e657200000000000000000060448201526064016108ce565b6002805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907ffbe5b6cbafb274f445d7fed869dc77a838d8243a22c460de156560e8857cad0390600090a35050565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff1663c59859186040518163ffffffff1660e01b8152600401602060405180830381865afa1580156106a6573d6000803e3d6000fd5b60025460009074010000000000000000000000000000000000000000900460ff1615610b7757620f4240610b62610b518461112a565b51610b5d90604461186b565b611447565b610b6d90601061182e565b6106369190611928565b6000610b82836114a6565b9050610b8c610385565b610b96908261186b565b9392505050565b60025473ffffffffffffffffffffffffffffffffffffffff163314610c1e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601a60248201527f43616c6c6572206973206e6f7420746865206f70657261746f7200000000000060448201526064016108ce565b600080548282556040519091839183917f5d6ae9db2d6725497bed0302a8212c0db5fdb3bd7d14f188a83b5589089caafd91a35050565b60025460009074010000000000000000000000000000000000000000900460ff16610d02576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603660248201527f47617350726963654f7261636c653a206765744c314665655570706572426f7560448201527f6e64206f6e6c7920737570706f7274732041727369610000000000000000000060648201526084016108ce565b6000610d0f83604461186b565b90506000610d1e60ff83611928565b610d28908361186b565b610d3390601061186b565b90506105ff81611536565b60015473ffffffffffffffffffffffffffffffffffffffff163314610dbf576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f43616c6c6572206973206e6f7420746865206f776e657200000000000000000060448201526064016108ce565b73ffffffffffffffffffffffffffffffffffffffff8116610e3c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601d60248201527f6e6577206f776e657220697320746865207a65726f206164647265737300000060448201526064016108ce565b6001805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16639e8c49666040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103e6573d6000803e3d6000fd5b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff1663f82061406040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103e6573d6000803e3d6000fd5b6000610636610f838361112a565b51610f8f90604461186b565b611536565b600080610fa083610b1b565b90506000610fac6106ca565b610fb6908361182e565b90506000610fc66006600a611a5c565b90506000610fd2610eb3565b610fdc908461182e565b90506000610fea8383611928565b979650505050505050565b60608160000361103857505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b8115611062578061104c81611a68565b915061105b9050600a83611928565b915061103c565b60008167ffffffffffffffff81111561107d5761107d6115e1565b6040519080825280601f01601f1916602001820160405280156110a7576020820181803683370190505b5090505b84156105ff576110bc600183611aa0565b91506110c9600a86611ab7565b6110d490603061186b565b60f81b8183815181106110e9576110e9611acb565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350611123600a86611928565b94506110ab565b60606112b9565b818153600101919050565b600082840393505b83811015610b965782810151828201511860001a1590930292600101611144565b825b602082106111b157825161117c601f83611131565b52602092909201917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe090910190602101611167565b8115610b965782516111c66001840383611131565b520160010192915050565b60006001830392505b6101078210611212576112048360ff166111ff60fd6111ff8760081c60e00189611131565b611131565b9350610106820391506111da565b6007821061123f576112388360ff166111ff600785036111ff8760081c60e00189611131565b9050610b96565b6105ff8360ff166111ff8560081c8560051b0187611131565b6112b182820361129561128584600081518060001a8160011a60081b178160021a60101b17915050919050565b639e3779b90260131c611fff1690565b8060021b6040510182815160e01c1860e01b8151188152505050565b600101919050565b6180003860405139618000604051016020830180600d8551820103826002015b818110156113ec576000805b50508051604051600082901a600183901a60081b1760029290921a60101b91909117639e3779b9810260111c617ffc16909101805160e081811c878603811890911b90911890915284019081830390848410611341575061137c565b600184019350611fff8211611376578251600081901a600182901a60081b1760029190911a60101b178103611376575061137c565b506112e5565b83831061138a5750506113ec565b600183039250858311156113a8576113a58787888603611165565b96505b6113bc60098501600385016003850161113c565b91506113c98782846111d1565b9650506113e1846113dc86848601611258565b611258565b9150508093506112d9565b50506113fe8383848851850103611165565b925050506040519150618000820180820391508183526020830160005b8381101561143357828101518282015260200161141b565b506000920191825250602001604052919050565b60008061145783620cc39461182e565b611481907ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd763200611afa565b90506114916064620f4240611b6e565b81121561063657610b966064620f4240611b6e565b80516000908190815b81811015611529578481815181106114c9576114c9611acb565b01602001517fff00000000000000000000000000000000000000000000000000000000000000166000036115095761150260048461186b565b9250611517565b61151460108461186b565b92505b8061152181611a68565b9150506114af565b506105ff8261044061186b565b60008061154283611447565b9050600061154e610f14565b6115566107ce565b63ffffffff16611566919061182e565b61156e6106ca565b611576610aba565b611581906010611c2a565b63ffffffff16611591919061182e565b61159b919061186b565b90506115a96006600261182e565b6115b490600a611a5c565b6115be828461182e565b6105ff9190611928565b6000602082840312156115da57600080fd5b5035919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60006020828403121561162257600080fd5b813567ffffffffffffffff8082111561163a57600080fd5b818401915084601f83011261164e57600080fd5b813581811115611660576116606115e1565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f011681019083821181831017156116a6576116a66115e1565b816040528281528760208487010111156116bf57600080fd5b826020860160208301376000928101602001929092525095945050505050565b60005b838110156116fa5781810151838201526020016116e2565b83811115611709576000848401525b50505050565b602081526000825180602084015261172e8160408501602087016116df565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169190910160400192915050565b60006020828403121561177257600080fd5b813573ffffffffffffffffffffffffffffffffffffffff81168114610b9657600080fd5b6000602082840312156117a857600080fd5b5051919050565b6000602082840312156117c157600080fd5b815167ffffffffffffffff81168114610b9657600080fd5b6000602082840312156117eb57600080fd5b815163ffffffff81168114610b9657600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615611866576118666117ff565b500290565b6000821982111561187e5761187e6117ff565b500190565b600084516118958184602089016116df565b80830190507f2e0000000000000000000000000000000000000000000000000000000000000080825285516118d1816001850160208a016116df565b600192019182015283516118ec8160028401602088016116df565b0160020195945050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b600082611937576119376118f9565b500490565b600181815b8085111561199557817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0482111561197b5761197b6117ff565b8085161561198857918102915b93841c9390800290611941565b509250929050565b6000826119ac57506001610636565b816119b957506000610636565b81600181146119cf57600281146119d9576119f5565b6001915050610636565b60ff8411156119ea576119ea6117ff565b50506001821b610636565b5060208310610133831016604e8410600b8410161715611a18575081810a610636565b611a22838361193c565b807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04821115611a5457611a546117ff565b029392505050565b6000610b96838361199d565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611a9957611a996117ff565b5060010190565b600082821015611ab257611ab26117ff565b500390565b600082611ac657611ac66118f9565b500690565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000808212827f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03841381151615611b3457611b346117ff565b827f8000000000000000000000000000000000000000000000000000000000000000038412811615611b6857611b686117ff565b50500190565b60007f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff600084136000841385830485118282161615611baf57611baf6117ff565b7f80000000000000000000000000000000000000000000000000000000000000006000871286820588128184161615611bea57611bea6117ff565b60008712925087820587128484161615611c0657611c066117ff565b87850587128184161615611c1c57611c1c6117ff565b505050929093029392505050565b600063ffffffff80831681851681830481118215151615611c4d57611c4d6117ff565b0294935050505056fea164736f6c634300080f000a")
	operatorFeeVaultArsiaDeploymentByteCode = common.FromHex("0x61012060405234801561001157600080fd5b506040516108e53803806108e58339810160408190526100309161005d565b678ac7230489e800006080526001600160a01b031660a052600160c081905260e05260006101005261008d565b60006020828403121561006f57600080fd5b81516001600160a01b038116811461008657600080fd5b9392505050565b60805160a05160c05160e051610100516108006100e560003960006103d3015260006103aa01526000610381015260008181607c015281816102570152610319015260008181610137015261015b01526108006000f3fe60806040526004361061005e5760003560e01c806354fd4d501161004357806354fd4d50146100df57806384411d6514610101578063d3e5792b1461012557600080fd5b80630d9019e11461006a5780633ccfd60b146100c857600080fd5b3661006557005b600080fd5b34801561007657600080fd5b5061009e7f000000000000000000000000000000000000000000000000000000000000000081565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020015b60405180910390f35b3480156100d457600080fd5b506100dd610159565b005b3480156100eb57600080fd5b506100f461037a565b6040516100bf91906105d4565b34801561010d57600080fd5b5061011760005481565b6040519081526020016100bf565b34801561013157600080fd5b506101177f000000000000000000000000000000000000000000000000000000000000000081565b7f0000000000000000000000000000000000000000000000000000000000000000471015610233576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152604a60248201527f4665655661756c743a207769746864726177616c20616d6f756e74206d75737460448201527f2062652067726561746572207468616e206d696e696d756d207769746864726160648201527f77616c20616d6f756e7400000000000000000000000000000000000000000000608482015260a40160405180910390fd5b600047905080600080828254610249919061061d565b9091555050604080518281527f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166020820152338183015290517fc8a211cc64b6ed1b50595a9fcb1932b6d1e5a6e8ef15b60e5b1f988ea9086bba9181900360600190a1604080516020810182526000815290517f548e0a5c0000000000000000000000000000000000000000000000000000000081527342000000000000000000000000000000000000109163548e0a5c918491610345917f0000000000000000000000000000000000000000000000000000000000000000916188b891600401610635565b6000604051808303818588803b15801561035e57600080fd5b505af1158015610372573d6000803e3d6000fd5b505050505050565b60606103a57f000000000000000000000000000000000000000000000000000000000000000061041d565b6103ce7f000000000000000000000000000000000000000000000000000000000000000061041d565b6103f77f000000000000000000000000000000000000000000000000000000000000000061041d565b60405160200161040993929190610679565b604051602081830303815290604052905090565b60608160000361046057505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b811561048a5780610474816106ef565b91506104839050600a83610756565b9150610464565b60008167ffffffffffffffff8111156104a5576104a561076a565b6040519080825280601f01601f1916602001820160405280156104cf576020820181803683370190505b5090505b8415610552576104e4600183610799565b91506104f1600a866107b0565b6104fc90603061061d565b60f81b818381518110610511576105116107c4565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535061054b600a86610756565b94506104d3565b949350505050565b60005b8381101561057557818101518382015260200161055d565b83811115610584576000848401525b50505050565b600081518084526105a281602086016020860161055a565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b6020815260006105e7602083018461058a565b9392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60008219821115610630576106306105ee565b500190565b73ffffffffffffffffffffffffffffffffffffffff8416815263ffffffff83166020820152606060408201526000610670606083018461058a565b95945050505050565b6000845161068b81846020890161055a565b80830190507f2e0000000000000000000000000000000000000000000000000000000000000080825285516106c7816001850160208a0161055a565b600192019182015283516106e281600284016020880161055a565b0160020195945050505050565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610720576107206105ee565b5060010190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b60008261076557610765610727565b500490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000828210156107ab576107ab6105ee565b500390565b6000826107bf576107bf610727565b500690565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea164736f6c634300080f000a0000000000000000000000002f44bd2a54ac3fb20cd7783cf94334069641dac9")
)

// ArsiaNetworkUpgradeTransactions returns the upgrade transactions for the Arsia network upgrade.
// The Arsia upgrade introduces operator fees and updates the L1 data fee calculation model.
func MantleArsiaNetworkUpgradeTransactions() ([]hexutil.Bytes, error) {
	upgradeTxns := make([]hexutil.Bytes, 0, 7)

	// 1. Deploy new L1Block implementation with operator fee support
	deployL1BlockTransaction, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaL1BlockSource.SourceHash(),
		From:                L1BlockArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 700_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                l1BlockArsiaDeploymentBytecode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployL1BlockTransaction)

	// 2. Deploy new GasPriceOracle implementation with Arsia fee calculation
	deployGasPriceOracle, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaGasPriceOracleSource.SourceHash(),
		From:                GasPriceOracleArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 1_800_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                gasPriceOracleArsiaDeploymentBytecode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployGasPriceOracle)

	// 3. Deploy new OperatorFeeVault implementation
	deployOperatorFeeVault, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaOperatorFeeVaultSource.SourceHash(),
		From:                OperatorFeeVaultArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 500_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                operatorFeeVaultArsiaDeploymentByteCode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployOperatorFeeVault)

	// 4. Upgrade L1Block proxy to new implementation
	updateL1BlockProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaL1BlockProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.L1BlockAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaL1BlockAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateL1BlockProxy)

	// 5. Upgrade GasPriceOracle proxy to new implementation
	updateGasPriceOracleProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaGasPriceOracleProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.GasPriceOracleAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaGasPriceOracleAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateGasPriceOracleProxy)

	// 6. Upgrade OperatorFeeVault proxy to new implementation
	updateOperatorFeeVaultProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaOperatorFeeVaultProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.OperatorFeeVaultAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaOperatorFeeVaultAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateOperatorFeeVaultProxy)

	// 7. Enable Arsia mode in GasPriceOracle
	enableArsia, err := types.NewTx(&types.DepositTx{
		SourceHash:          enableArsiaSource.SourceHash(),
		From:                L1InfoDepositerAddress,
		To:                  &predeploys.GasPriceOracleAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 100_000,
		IsSystemTransaction: false,
		Data:                enableArsiaInput,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, enableArsia)

	return upgradeTxns, nil
}

func upgradeToCalldata(addr common.Address) []byte {
	buf := bytes.NewBuffer(make([]byte, 0, 4+20))
	if err := solabi.WriteSignature(buf, UpgradeToFuncBytes4); err != nil {
		panic(fmt.Errorf("failed to write upgradeTo signature data: %w", err))
	}
	if err := solabi.WriteAddress(buf, addr); err != nil {
		panic(fmt.Errorf("failed to write upgradeTo address data: %w", err))
	}
	return buf.Bytes()
}

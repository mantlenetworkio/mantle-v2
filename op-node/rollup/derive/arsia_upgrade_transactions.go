package derive

import (
	"bytes"
	"fmt"
	"math/big"

	"github.com/ethereum-optimism/optimism/op-service/predeploys"
	"github.com/ethereum-optimism/optimism/op-service/solabi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
)

const UpgradeToFuncSignature = "upgradeTo(address)"

var (
	// L1Block Parameters for Arsia
	deployArsiaL1BlockSource      = UpgradeDepositSource{Intent: "Arsia: L1 Block Deployment"}
	updateArsiaL1BlockProxySource = UpgradeDepositSource{Intent: "Arsia: L1 Block Proxy Update"}
	L1BlockArsiaDeployerAddress   = common.HexToAddress("0x4210000000000000000000000000000000000000")
	arsiaL1BlockAddress           = crypto.CreateAddress(L1BlockArsiaDeployerAddress, 0)

	// Gas Price Oracle Parameters for Arsia
	deployArsiaGasPriceOracleSource      = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Deployment"}
	updateArsiaGasPriceOracleProxySource = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Proxy Update"}
	GasPriceOracleArsiaDeployerAddress   = common.HexToAddress("0x4210000000000000000000000000000000000001")
	arsiaGasPriceOracleAddress           = crypto.CreateAddress(GasPriceOracleArsiaDeployerAddress, 0)

	// Enable Arsia Parameters
	enableArsiaSource = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Set Arsia"}
	enableArsiaInput  = crypto.Keccak256([]byte("setArsia()"))[:4]

	UpgradeToFuncBytes4 = crypto.Keccak256([]byte(UpgradeToFuncSignature))[:4]

	// Bytecodes for Arsia
	// Run:
	// cat forge-artifacts/L1Block.sol/L1Block.json | jq -r '.bytecode.object' > l1block_bytecode.txt
	// cat forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json | jq -r '.bytecode.object' > gpo_bytecode.txt
	l1BlockArsiaDeploymentBytecode        = common.FromHex("0x60e060405234801561001057600080fd5b506001608081905260a052600060c05260805160a05160c05161096061004f600039600061044b01526000610422015260006103f901526109606000f3fe608060405234801561001057600080fd5b506004361061011b5760003560e01c806368d5dca6116100b2578063b80777ea11610081578063e591b28211610066578063e591b28214610257578063e81b2c6d14610297578063f8206140146102a057600080fd5b8063b80777ea14610227578063c59859181461024757600080fd5b806368d5dca6146101e95780638381f58a146102015780638b239f73146102155780639e8c49661461021e57600080fd5b80634d5d9a2a116100ee5780634d5d9a2a1461018657806354fd4d50146101b75780635cf24969146101cc57806364ca23ef146101d557600080fd5b8063015d8eb91461012057806309bd5a601461013557806316d3bc7f1461015157806349e723831461017e575b600080fd5b61013361012e36600461069f565b6102a9565b005b61013e60025481565b6040519081526020015b60405180910390f35b6009546101659067ffffffffffffffff1681565b60405167ffffffffffffffff9091168152602001610148565b6101336103e8565b6009546101a29068010000000000000000900463ffffffff1681565b60405163ffffffff9091168152602001610148565b6101bf6103f2565b6040516101489190610741565b61013e60015481565b6003546101659067ffffffffffffffff1681565b6007546101a290640100000000900463ffffffff1681565b6000546101659067ffffffffffffffff1681565b61013e60055481565b61013e60065481565b6000546101659068010000000000000000900467ffffffffffffffff1681565b6007546101a29063ffffffff1681565b61027273deaddeaddeaddeaddeaddeaddeaddeaddead000181565b60405173ffffffffffffffffffffffffffffffffffffffff9091168152602001610148565b61013e60045481565b61013e60085481565b3373deaddeaddeaddeaddeaddeaddeaddeaddead000114610350576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603b60248201527f4c31426c6f636b3a206f6e6c7920746865206465706f7369746f72206163636f60448201527f756e742063616e20736574204c3120626c6f636b2076616c7565730000000000606482015260840160405180910390fd5b6000805467ffffffffffffffff98891668010000000000000000027fffffffffffffffffffffffffffffffff00000000000000000000000000000000909116998916999099179890981790975560019490945560029290925560038054919094167fffffffffffffffffffffffffffffffffffffffffffffffff00000000000000009190911617909255600491909155600555600655565b6103f0610495565b565b606061041d7f0000000000000000000000000000000000000000000000000000000000000000610545565b6104467f0000000000000000000000000000000000000000000000000000000000000000610545565b61046f7f0000000000000000000000000000000000000000000000000000000000000000610545565b60405160200161048193929190610792565b604051602081830303815290604052905090565b3373deaddeaddeaddeaddeaddeaddeaddeaddead0001146104be57633cc50b456000526004601cfd5b6004803560e081901c60a091821c67ffffffff000000001617600755600c3560c01c60035567ffffffffffffffff60143560801c8181166fffffffffffffffff0000000000000000919091161760005560243560015560443560085560643560025560843590925560a435901c9081166bffffffff00000000000000009190911617600955565b60608160000361058857505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b81156105b2578061059c81610837565b91506105ab9050600a8361089e565b915061058c565b60008167ffffffffffffffff8111156105cd576105cd6108b2565b6040519080825280601f01601f1916602001820160405280156105f7576020820181803683370190505b5090505b841561067a5761060c6001836108e1565b9150610619600a866108f8565b61062490603061090c565b60f81b81838151811061063957610639610924565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350610673600a8661089e565b94506105fb565b949350505050565b803567ffffffffffffffff8116811461069a57600080fd5b919050565b600080600080600080600080610100898b0312156106bc57600080fd5b6106c589610682565b97506106d360208a01610682565b965060408901359550606089013594506106ef60808a01610682565b979a969950949793969560a0850135955060c08501359460e001359350915050565b60005b8381101561072c578181015183820152602001610714565b8381111561073b576000848401525b50505050565b6020815260008251806020840152610760816040850160208701610711565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169190910160400192915050565b600084516107a4818460208901610711565b80830190507f2e0000000000000000000000000000000000000000000000000000000000000080825285516107e0816001850160208a01610711565b600192019182015283516107fb816002840160208801610711565b0160020195945050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361086857610868610808565b5060010190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000826108ad576108ad61086f565b500490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000828210156108f3576108f3610808565b500390565b6000826109075761090761086f565b500690565b6000821982111561091f5761091f610808565b500190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea164736f6c634300080f000a")
	gasPriceOracleArsiaDeploymentBytecode = common.FromHex("0x60e060405234801561001057600080fd5b506001608081905260a052600060c05260805160a05160c05161155e61004f60003960006106960152600061066d01526000610644015261155e6000f3fe608060405234801561001057600080fd5b50600436106101985760003560e01c806368d5dca6116100e3578063de26c4a11161008c578063f45e65d811610066578063f45e65d814610357578063f82061401461035f578063fe173b97146102d357600080fd5b8063de26c4a11461031e578063e38e91f914610331578063f2fde38b1461034457600080fd5b80638f018a7b116100bd5780638f018a7b146102f9578063b3ab15fb14610303578063c59859181461031657600080fd5b806368d5dca6146102cb5780636ef25c3a146102d35780638da5cb5b146102d957600080fd5b8063313ce56711610145578063519b4bd31161011f578063519b4bd31461026957806354fd4d5014610271578063570ca7351461028657600080fd5b8063313ce5671461023257806349948e0e146102395780634d5d9a2a1461024c57600080fd5b80631e2b6e7b116101765780631e2b6e7b146101e2578063275aedd2146102175780632e0f26251461022a57600080fd5b806306f837d31461019d5780630c18c162146101b957806316d3bc7f146101c1575b600080fd5b6101a660005481565b6040519081526020015b60405180910390f35b6101a6610367565b6101c96103f1565b60405167ffffffffffffffff90911681526020016101b0565b6002546102079074010000000000000000000000000000000000000000900460ff1681565b60405190151581526020016101b0565b6101a6610225366004610ff3565b610476565b6101a6600681565b60066101a6565b6101a661024736600461103b565b61051f565b610254610557565b60405163ffffffff90911681526020016101b0565b6101a66105dc565b61027961063d565b6040516101b0919061113a565b6002546102a69073ffffffffffffffffffffffffffffffffffffffff1681565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020016101b0565b6102546106e0565b486101a6565b6001546102a69073ffffffffffffffffffffffffffffffffffffffff1681565b610301610741565b005b61030161031136600461118b565b6108b2565b6102546109aa565b6101a661032c36600461103b565b610a0b565b61030161033f366004610ff3565b610a32565b61030161035236600461118b565b610aea565b6101a6610c5f565b6101a6610cc0565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16638b239f736040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c8573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103ec91906111c1565b905090565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff166316d3bc7f6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610452573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103ec91906111da565b60025460009074010000000000000000000000000000000000000000900460ff166104a357506000919050565b610519620f42406104f1846104b6610557565b63ffffffff167fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821583830293840490921491909117011790565b6104fb9190611262565b6105036103f1565b67ffffffffffffffff1681019081106000031790565b92915050565b60025460009074010000000000000000000000000000000000000000900460ff161561054e5761051982610d21565b61051982610dc5565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16634d5d9a2a6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105b8573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103ec9190611276565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16635cf249696040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c8573d6000803e3d6000fd5b60606106687f0000000000000000000000000000000000000000000000000000000000000000610e26565b6106917f0000000000000000000000000000000000000000000000000000000000000000610e26565b6106ba7f0000000000000000000000000000000000000000000000000000000000000000610e26565b6040516020016106cc9392919061129c565b604051602081830303815290604052905090565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff166368d5dca66040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105b8573d6000803e3d6000fd5b60015473ffffffffffffffffffffffffffffffffffffffff1633146107c7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f43616c6c6572206973206e6f7420746865206f776e657200000000000000000060448201526064015b60405180910390fd5b60025474010000000000000000000000000000000000000000900460ff1615610871576040517f08c379a0000000000000000000000000000000000000000000000000000000008152602060048201526024808201527f47617350726963654f7261636c653a20417273696120616c726561647920616360448201527f746976650000000000000000000000000000000000000000000000000000000060648201526084016107be565b600280547fffffffffffffffffffffff00ffffffffffffffffffffffffffffffffffffffff1674010000000000000000000000000000000000000000179055565b60015473ffffffffffffffffffffffffffffffffffffffff163314610933576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f43616c6c6572206973206e6f7420746865206f776e657200000000000000000060448201526064016107be565b6002805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907ffbe5b6cbafb274f445d7fed869dc77a838d8243a22c460de156560e8857cad0390600090a35050565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff1663c59859186040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105b8573d6000803e3d6000fd5b600080610a1783610f63565b9050610a21610367565b610a2b9082611312565b9392505050565b60025473ffffffffffffffffffffffffffffffffffffffff163314610ab3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601a60248201527f43616c6c6572206973206e6f7420746865206f70657261746f7200000000000060448201526064016107be565b600080548282556040519091839183917f5d6ae9db2d6725497bed0302a8212c0db5fdb3bd7d14f188a83b5589089caafd91a35050565b60015473ffffffffffffffffffffffffffffffffffffffff163314610b6b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f43616c6c6572206973206e6f7420746865206f776e657200000000000000000060448201526064016107be565b73ffffffffffffffffffffffffffffffffffffffff8116610be8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601d60248201527f6e6577206f776e657220697320746865207a65726f206164647265737300000060448201526064016107be565b6001805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16639e8c49666040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c8573d6000803e3d6000fd5b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff1663f82061406040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c8573d6000803e3d6000fd5b600080610d2d83610f63565b90506000610d396105dc565b610d416109aa565b610d4c90601061132a565b63ffffffff16610d5c9190611356565b90506000610d68610cc0565b610d706106e0565b63ffffffff16610d809190611356565b90506000610d8e8284611312565b610d989085611356565b9050610da66006600a6114b3565b610db1906010611356565b610dbb9082611262565b9695505050505050565b600080610dd183610a0b565b90506000610ddd6105dc565b610de79083611356565b90506000610df76006600a6114b3565b90506000610e03610c5f565b610e0d9084611356565b90506000610e1b8383611262565b979650505050505050565b606081600003610e6957505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b8115610e935780610e7d816114bf565b9150610e8c9050600a83611262565b9150610e6d565b60008167ffffffffffffffff811115610eae57610eae61100c565b6040519080825280601f01601f191660200182016040528015610ed8576020820181803683370190505b5090505b8415610f5b57610eed6001836114f7565b9150610efa600a8661150e565b610f05906030611312565b60f81b818381518110610f1a57610f1a611522565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350610f54600a86611262565b9450610edc565b949350505050565b80516000908190815b81811015610fe657848181518110610f8657610f86611522565b01602001517fff0000000000000000000000000000000000000000000000000000000000000016600003610fc657610fbf600484611312565b9250610fd4565b610fd1601084611312565b92505b80610fde816114bf565b915050610f6c565b50610f5b82610440611312565b60006020828403121561100557600080fd5b5035919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60006020828403121561104d57600080fd5b813567ffffffffffffffff8082111561106557600080fd5b818401915084601f83011261107957600080fd5b81358181111561108b5761108b61100c565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f011681019083821181831017156110d1576110d161100c565b816040528281528760208487010111156110ea57600080fd5b826020860160208301376000928101602001929092525095945050505050565b60005b8381101561112557818101518382015260200161110d565b83811115611134576000848401525b50505050565b602081526000825180602084015261115981604085016020870161110a565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169190910160400192915050565b60006020828403121561119d57600080fd5b813573ffffffffffffffffffffffffffffffffffffffff81168114610a2b57600080fd5b6000602082840312156111d357600080fd5b5051919050565b6000602082840312156111ec57600080fd5b815167ffffffffffffffff81168114610a2b57600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60008261127157611271611204565b500490565b60006020828403121561128857600080fd5b815163ffffffff81168114610a2b57600080fd5b600084516112ae81846020890161110a565b80830190507f2e0000000000000000000000000000000000000000000000000000000000000080825285516112ea816001850160208a0161110a565b6001920191820152835161130581600284016020880161110a565b0160020195945050505050565b6000821982111561132557611325611233565b500190565b600063ffffffff8083168185168183048111821515161561134d5761134d611233565b02949350505050565b6000817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048311821515161561138e5761138e611233565b500290565b600181815b808511156113ec57817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048211156113d2576113d2611233565b808516156113df57918102915b93841c9390800290611398565b509250929050565b60008261140357506001610519565b8161141057506000610519565b816001811461142657600281146114305761144c565b6001915050610519565b60ff84111561144157611441611233565b50506001821b610519565b5060208310610133831016604e8410600b841016171561146f575081810a610519565b6114798383611393565b807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048211156114ab576114ab611233565b029392505050565b6000610a2b83836113f4565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036114f0576114f0611233565b5060010190565b60008282101561150957611509611233565b500390565b60008261151d5761151d611204565b500690565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea164736f6c634300080f000a")
)

// ArsiaNetworkUpgradeTransactions returns the upgrade transactions for the Arsia network upgrade.
// The Arsia upgrade introduces operator fees and updates the L1 data fee calculation model.
func MantleArsiaNetworkUpgradeTransactions() ([]hexutil.Bytes, error) {
	upgradeTxns := make([]hexutil.Bytes, 0, 5)

	// 1. Deploy new L1Block implementation with operator fee support
	deployL1BlockTransaction, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaL1BlockSource.SourceHash(),
		From:                L1BlockArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 500_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                l1BlockArsiaDeploymentBytecode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployL1BlockTransaction)

	// 2. Deploy new GasPriceOracle implementation with Arsia fee calculation
	deployGasPriceOracle, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaGasPriceOracleSource.SourceHash(),
		From:                GasPriceOracleArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 1_200_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                gasPriceOracleArsiaDeploymentBytecode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployGasPriceOracle)

	// 3. Upgrade L1Block proxy to new implementation
	updateL1BlockProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaL1BlockProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.L1BlockAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaL1BlockAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateL1BlockProxy)

	// 4. Upgrade GasPriceOracle proxy to new implementation
	updateGasPriceOracleProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaGasPriceOracleProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.GasPriceOracleAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaGasPriceOracleAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateGasPriceOracleProxy)

	// 5. Enable Arsia mode in GasPriceOracle
	enableArsia, err := types.NewTx(&types.DepositTx{
		SourceHash:          enableArsiaSource.SourceHash(),
		From:                L1InfoDepositerAddress,
		To:                  &predeploys.GasPriceOracleAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 100_000,
		IsSystemTransaction: false,
		Data:                enableArsiaInput,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, enableArsia)

	return upgradeTxns, nil
}

func upgradeToCalldata(addr common.Address) []byte {
	buf := bytes.NewBuffer(make([]byte, 0, 4+20))
	if err := solabi.WriteSignature(buf, UpgradeToFuncBytes4); err != nil {
		panic(fmt.Errorf("failed to write upgradeTo signature data: %w", err))
	}
	if err := solabi.WriteAddress(buf, addr); err != nil {
		panic(fmt.Errorf("failed to write upgradeTo address data: %w", err))
	}
	return buf.Bytes()
}

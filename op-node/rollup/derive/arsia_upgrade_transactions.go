package derive

import (
	"bytes"
	"fmt"
	"math/big"

	"github.com/ethereum-optimism/optimism/op-service/predeploys"
	"github.com/ethereum-optimism/optimism/op-service/solabi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
)

const UpgradeToFuncSignature = "upgradeTo(address)"

var (
	// L1Block Parameters for Arsia
	deployArsiaL1BlockSource      = UpgradeDepositSource{Intent: "Arsia: L1 Block Deployment"}
	updateArsiaL1BlockProxySource = UpgradeDepositSource{Intent: "Arsia: L1 Block Proxy Update"}
	L1BlockArsiaDeployerAddress   = common.HexToAddress("0x4210000000000000000000000000000000000000")
	arsiaL1BlockAddress           = crypto.CreateAddress(L1BlockArsiaDeployerAddress, 0)

	// Gas Price Oracle Parameters for Arsia
	deployArsiaGasPriceOracleSource      = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Deployment"}
	updateArsiaGasPriceOracleProxySource = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Proxy Update"}
	GasPriceOracleArsiaDeployerAddress   = common.HexToAddress("0x4210000000000000000000000000000000000001")
	arsiaGasPriceOracleAddress           = crypto.CreateAddress(GasPriceOracleArsiaDeployerAddress, 0)

	// Operator Fee Vault Parameters for Arsia
	deployArsiaOperatorFeeVaultSource      = UpgradeDepositSource{Intent: "Arsia: Operator Fee Vault Deployment"}
	updateArsiaOperatorFeeVaultProxySource = UpgradeDepositSource{Intent: "Arsia: Operator Fee Vault Proxy Update"}
	OperatorFeeVaultArsiaDeployerAddress   = common.HexToAddress("0x4210000000000000000000000000000000000002")
	arsiaOperatorFeeVaultAddress           = crypto.CreateAddress(OperatorFeeVaultArsiaDeployerAddress, 0)

	// Enable Arsia Parameters
	enableArsiaSource = UpgradeDepositSource{Intent: "Arsia: Gas Price Oracle Set Arsia"}
	enableArsiaInput  = crypto.Keccak256([]byte("setArsia()"))[:4]

	UpgradeToFuncBytes4 = crypto.Keccak256([]byte(UpgradeToFuncSignature))[:4]

	// Bytecodes for Arsia
	// Run:
	// cat forge-artifacts/L1Block.sol/L1Block.json | jq -r '.bytecode.object' > l1block_bytecode.txt
	// cat forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json | jq -r '.bytecode.object' > gpo_bytecode.txt
	// cat forge-artifacts/OperatorFeeVault.sol/OperatorFeeVault.json | | jq -r '.bytecode.object' > ofv_bytecode.txt
	//   And sufix bytecode with constructor arguments 'abi.encode(operator_fee_vault_recipient_address)'
	l1BlockArsiaDeploymentBytecode          = common.FromHex("0x60e060405234801561001057600080fd5b506001608081905260a052600060c05260805160a05160c05161090661004f600039600061044101526000610418015260006103ef01526109066000f3fe608060405234801561001057600080fd5b506004361061011b5760003560e01c806368d5dca6116100b2578063b80777ea11610081578063e591b28211610066578063e591b2821461026b578063e81b2c6d1461028d578063f82061401461029657600080fd5b8063b80777ea1461022b578063c59859181461024b57600080fd5b806368d5dca6146101e95780638381f58a146102055780638b239f73146102195780639e8c49661461022257600080fd5b80634d5d9a2a116100ee5780634d5d9a2a1461018657806354fd4d50146101b75780635cf24969146101cc57806364ca23ef146101d557600080fd5b8063015d8eb91461012057806309bd5a601461013557806316d3bc7f1461015157806349e723831461017e575b600080fd5b61013361012e366004610645565b61029f565b005b61013e60025481565b6040519081526020015b60405180910390f35b6008546101659067ffffffffffffffff1681565b60405167ffffffffffffffff9091168152602001610148565b6101336103de565b6008546101a29068010000000000000000900463ffffffff1681565b60405163ffffffff9091168152602001610148565b6101bf6103e8565b60405161014891906106e7565b61013e60015481565b6003546101659067ffffffffffffffff1681565b6003546101a29068010000000000000000900463ffffffff1681565b6000546101659067ffffffffffffffff1681565b61013e60055481565b61013e60065481565b6000546101659068010000000000000000900467ffffffffffffffff1681565b6003546101a2906c01000000000000000000000000900463ffffffff1681565b60405173deaddeaddeaddeaddeaddeaddeaddeaddead00018152602001610148565b61013e60045481565b61013e60075481565b3373deaddeaddeaddeaddeaddeaddeaddeaddead000114610346576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603b60248201527f4c31426c6f636b3a206f6e6c7920746865206465706f7369746f72206163636f60448201527f756e742063616e20736574204c3120626c6f636b2076616c7565730000000000606482015260840160405180910390fd5b6000805467ffffffffffffffff98891668010000000000000000027fffffffffffffffffffffffffffffffff00000000000000000000000000000000909116998916999099179890981790975560019490945560029290925560038054919094167fffffffffffffffffffffffffffffffffffffffffffffffff00000000000000009190911617909255600491909155600555600655565b6103e661048b565b565b60606104137f00000000000000000000000000000000000000000000000000000000000000006104eb565b61043c7f00000000000000000000000000000000000000000000000000000000000000006104eb565b6104657f00000000000000000000000000000000000000000000000000000000000000006104eb565b60405160200161047793929190610738565b604051602081830303815290604052905090565b73deaddeaddeaddeaddeaddeaddeaddeaddead00013381146104b557633cc50b456000526004601cfd5b60043560801c60035560143560801c60005560243560015560443560075560643560025560843560045560a43560a01c60085550565b60608160000361052e57505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b81156105585780610542816107dd565b91506105519050600a83610844565b9150610532565b60008167ffffffffffffffff81111561057357610573610858565b6040519080825280601f01601f19166020018201604052801561059d576020820181803683370190505b5090505b8415610620576105b2600183610887565b91506105bf600a8661089e565b6105ca9060306108b2565b60f81b8183815181106105df576105df6108ca565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350610619600a86610844565b94506105a1565b949350505050565b803567ffffffffffffffff8116811461064057600080fd5b919050565b600080600080600080600080610100898b03121561066257600080fd5b61066b89610628565b975061067960208a01610628565b9650604089013595506060890135945061069560808a01610628565b979a969950949793969560a0850135955060c08501359460e001359350915050565b60005b838110156106d25781810151838201526020016106ba565b838111156106e1576000848401525b50505050565b60208152600082518060208401526107068160408501602087016106b7565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169190910160400192915050565b6000845161074a8184602089016106b7565b80830190507f2e000000000000000000000000000000000000000000000000000000000000008082528551610786816001850160208a016106b7565b600192019182015283516107a18160028401602088016106b7565b0160020195945050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361080e5761080e6107ae565b5060010190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b60008261085357610853610815565b500490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600082821015610899576108996107ae565b500390565b6000826108ad576108ad610815565b500690565b600082198211156108c5576108c56107ae565b500190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea164736f6c634300080f000a")
	gasPriceOracleArsiaDeploymentBytecode   = common.FromHex("0x60e060405234801561001057600080fd5b506001608081905260a052600060c05260805160a05160c051611b9b61004f60003960006106b40152600061068b015260006106620152611b9b6000f3fe608060405234801561001057600080fd5b50600436106101a35760003560e01c806368d5dca6116100ee578063de26c4a111610097578063f2fde38b11610071578063f2fde38b14610362578063f45e65d814610375578063f82061401461037d578063fe173b97146102de57600080fd5b8063de26c4a114610329578063e38e91f91461033c578063f1c7a58b1461034f57600080fd5b80638f018a7b116100c85780638f018a7b14610304578063b3ab15fb1461030e578063c59859181461032157600080fd5b806368d5dca6146102d65780636ef25c3a146102de5780638da5cb5b146102e457600080fd5b8063313ce56711610150578063519b4bd31161012a578063519b4bd31461027457806354fd4d501461027c578063570ca7351461029157600080fd5b8063313ce5671461023d57806349948e0e146102445780634d5d9a2a1461025757600080fd5b80631e2b6e7b116101815780631e2b6e7b146101ed578063275aedd2146102225780632e0f26251461023557600080fd5b806306f837d3146101a85780630c18c162146101c457806316d3bc7f146101cc575b600080fd5b6101b160005481565b6040519081526020015b60405180910390f35b6101b1610385565b6101d461040f565b60405167ffffffffffffffff90911681526020016101bb565b6002546102129074010000000000000000000000000000000000000000900460ff1681565b60405190151581526020016101bb565b6101b1610230366004611500565b610494565b6101b1600681565b60066101b1565b6101b1610252366004611548565b61053d565b61025f610575565b60405163ffffffff90911681526020016101bb565b6101b16105fa565b61028461065b565b6040516101bb9190611647565b6002546102b19073ffffffffffffffffffffffffffffffffffffffff1681565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020016101bb565b61025f6106fe565b486101b1565b6001546102b19073ffffffffffffffffffffffffffffffffffffffff1681565b61030c61075f565b005b61030c61031c366004611698565b6108f2565b61025f6109ea565b6101b1610337366004611548565b610a4b565b61030c61034a366004611500565b610acd565b6101b161035d366004611500565b610b85565b61030c610370366004611698565b610c76565b6101b1610deb565b6101b1610e4c565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16638b239f736040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103e6573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061040a91906116ce565b905090565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff166316d3bc7f6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610470573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061040a91906116e7565b60025460009074010000000000000000000000000000000000000000900460ff166104c157506000919050565b610537620f424061050f846104d4610575565b63ffffffff167fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821583830293840490921491909117011790565b610519919061176f565b61052161040f565b67ffffffffffffffff1681019081106000031790565b92915050565b60025460009074010000000000000000000000000000000000000000900460ff161561056c5761053782610ead565b61053782610ecc565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16634d5d9a2a6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105d6573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061040a9190611783565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16635cf249696040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103e6573d6000803e3d6000fd5b60606106867f0000000000000000000000000000000000000000000000000000000000000000610f2d565b6106af7f0000000000000000000000000000000000000000000000000000000000000000610f2d565b6106d87f0000000000000000000000000000000000000000000000000000000000000000610f2d565b6040516020016106ea939291906117a9565b604051602081830303815290604052905090565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff166368d5dca66040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105d6573d6000803e3d6000fd5b3373deaddeaddeaddeaddeaddeaddeaddeaddead000114610807576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603f60248201527f47617350726963654f7261636c653a206f6e6c7920746865206465706f73697460448201527f6f72206163636f756e742063616e20736574206973417273696120666c61670060648201526084015b60405180910390fd5b60025474010000000000000000000000000000000000000000900460ff16156108b1576040517f08c379a0000000000000000000000000000000000000000000000000000000008152602060048201526024808201527f47617350726963654f7261636c653a20417273696120616c726561647920616360448201527f746976650000000000000000000000000000000000000000000000000000000060648201526084016107fe565b600280547fffffffffffffffffffffff00ffffffffffffffffffffffffffffffffffffffff1674010000000000000000000000000000000000000000179055565b60015473ffffffffffffffffffffffffffffffffffffffff163314610973576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f43616c6c6572206973206e6f7420746865206f776e657200000000000000000060448201526064016107fe565b6002805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907ffbe5b6cbafb274f445d7fed869dc77a838d8243a22c460de156560e8857cad0390600090a35050565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff1663c59859186040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105d6573d6000803e3d6000fd5b60025460009074010000000000000000000000000000000000000000900460ff1615610aa757620f4240610a92610a8184611062565b51610a8d90604461181f565b61137f565b610a9d906010611837565b610537919061176f565b6000610ab2836113de565b9050610abc610385565b610ac6908261181f565b9392505050565b60025473ffffffffffffffffffffffffffffffffffffffff163314610b4e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601a60248201527f43616c6c6572206973206e6f7420746865206f70657261746f7200000000000060448201526064016107fe565b600080548282556040519091839183917f5d6ae9db2d6725497bed0302a8212c0db5fdb3bd7d14f188a83b5589089caafd91a35050565b60025460009074010000000000000000000000000000000000000000900460ff16610c32576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603660248201527f47617350726963654f7261636c653a206765744c314665655570706572426f7560448201527f6e64206f6e6c7920737570706f7274732041727369610000000000000000000060648201526084016107fe565b6000610c3f83604461181f565b90506000610c4e60ff8361176f565b610c58908361181f565b610c6390601061181f565b9050610c6e8161146e565b949350505050565b60015473ffffffffffffffffffffffffffffffffffffffff163314610cf7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f43616c6c6572206973206e6f7420746865206f776e657200000000000000000060448201526064016107fe565b73ffffffffffffffffffffffffffffffffffffffff8116610d74576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601d60248201527f6e6577206f776e657220697320746865207a65726f206164647265737300000060448201526064016107fe565b6001805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff16639e8c49666040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103e6573d6000803e3d6000fd5b600073420000000000000000000000000000000000001573ffffffffffffffffffffffffffffffffffffffff1663f82061406040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103e6573d6000803e3d6000fd5b6000610537610ebb83611062565b51610ec790604461181f565b61146e565b600080610ed883610a4b565b90506000610ee46105fa565b610eee9083611837565b90506000610efe6006600a611994565b90506000610f0a610deb565b610f149084611837565b90506000610f22838361176f565b979650505050505050565b606081600003610f7057505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b8115610f9a5780610f84816119a0565b9150610f939050600a8361176f565b9150610f74565b60008167ffffffffffffffff811115610fb557610fb5611519565b6040519080825280601f01601f191660200182016040528015610fdf576020820181803683370190505b5090505b8415610c6e57610ff46001836119d8565b9150611001600a866119ef565b61100c90603061181f565b60f81b81838151811061102157611021611a03565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535061105b600a8661176f565b9450610fe3565b60606111f1565b818153600101919050565b600082840393505b83811015610ac65782810151828201511860001a159093029260010161107c565b825b602082106110e95782516110b4601f83611069565b52602092909201917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe09091019060210161109f565b8115610ac65782516110fe6001840383611069565b520160010192915050565b60006001830392505b610107821061114a5761113c8360ff1661113760fd6111378760081c60e00189611069565b611069565b935061010682039150611112565b60078210611177576111708360ff16611137600785036111378760081c60e00189611069565b9050610ac6565b610c6e8360ff166111378560081c8560051b0187611069565b6111e98282036111cd6111bd84600081518060001a8160011a60081b178160021a60101b17915050919050565b639e3779b90260131c611fff1690565b8060021b6040510182815160e01c1860e01b8151188152505050565b600101919050565b6180003860405139618000604051016020830180600d8551820103826002015b81811015611324576000805b50508051604051600082901a600183901a60081b1760029290921a60101b91909117639e3779b9810260111c617ffc16909101805160e081811c878603811890911b9091189091528401908183039084841061127957506112b4565b600184019350611fff82116112ae578251600081901a600182901a60081b1760029190911a60101b1781036112ae57506112b4565b5061121d565b8383106112c2575050611324565b600183039250858311156112e0576112dd878788860361109d565b96505b6112f4600985016003850160038501611074565b9150611301878284611109565b9650506113198461131486848601611190565b611190565b915050809350611211565b5050611336838384885185010361109d565b925050506040519150618000820180820391508183526020830160005b8381101561136b578281015182820152602001611353565b506000920191825250602001604052919050565b60008061138f83620cc394611837565b6113b9907ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd763200611a32565b90506113c96064620f4240611aa6565b81121561053757610ac66064620f4240611aa6565b80516000908190815b818110156114615784818151811061140157611401611a03565b01602001517fff00000000000000000000000000000000000000000000000000000000000000166000036114415761143a60048461181f565b925061144f565b61144c60108461181f565b92505b80611459816119a0565b9150506113e7565b50610c6e8261044061181f565b60008061147a8361137f565b90506000611486610e4c565b61148e6106fe565b63ffffffff1661149e9190611837565b6114a66105fa565b6114ae6109ea565b6114b9906010611b62565b63ffffffff166114c99190611837565b6114d3919061181f565b90506114e160066002611837565b6114ec90600a611994565b6114f68284611837565b610c6e919061176f565b60006020828403121561151257600080fd5b5035919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60006020828403121561155a57600080fd5b813567ffffffffffffffff8082111561157257600080fd5b818401915084601f83011261158657600080fd5b81358181111561159857611598611519565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f011681019083821181831017156115de576115de611519565b816040528281528760208487010111156115f757600080fd5b826020860160208301376000928101602001929092525095945050505050565b60005b8381101561163257818101518382015260200161161a565b83811115611641576000848401525b50505050565b6020815260008251806020840152611666816040850160208701611617565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169190910160400192915050565b6000602082840312156116aa57600080fd5b813573ffffffffffffffffffffffffffffffffffffffff81168114610ac657600080fd5b6000602082840312156116e057600080fd5b5051919050565b6000602082840312156116f957600080fd5b815167ffffffffffffffff81168114610ac657600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60008261177e5761177e611711565b500490565b60006020828403121561179557600080fd5b815163ffffffff81168114610ac657600080fd5b600084516117bb818460208901611617565b80830190507f2e0000000000000000000000000000000000000000000000000000000000000080825285516117f7816001850160208a01611617565b60019201918201528351611812816002840160208801611617565b0160020195945050505050565b6000821982111561183257611832611740565b500190565b6000817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048311821515161561186f5761186f611740565b500290565b600181815b808511156118cd57817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048211156118b3576118b3611740565b808516156118c057918102915b93841c9390800290611879565b509250929050565b6000826118e457506001610537565b816118f157506000610537565b816001811461190757600281146119115761192d565b6001915050610537565b60ff84111561192257611922611740565b50506001821b610537565b5060208310610133831016604e8410600b8410161715611950575081810a610537565b61195a8383611874565b807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0482111561198c5761198c611740565b029392505050565b6000610ac683836118d5565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036119d1576119d1611740565b5060010190565b6000828210156119ea576119ea611740565b500390565b6000826119fe576119fe611711565b500690565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000808212827f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03841381151615611a6c57611a6c611740565b827f8000000000000000000000000000000000000000000000000000000000000000038412811615611aa057611aa0611740565b50500190565b60007f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff600084136000841385830485118282161615611ae757611ae7611740565b7f80000000000000000000000000000000000000000000000000000000000000006000871286820588128184161615611b2257611b22611740565b60008712925087820587128484161615611b3e57611b3e611740565b87850587128184161615611b5457611b54611740565b505050929093029392505050565b600063ffffffff80831681851681830481118215151615611b8557611b85611740565b0294935050505056fea164736f6c634300080f000a")
	operatorFeeVaultArsiaDeploymentByteCode = common.FromHex("0x61012060405234801561001157600080fd5b506040516108e53803806108e58339810160408190526100309161005d565b678ac7230489e800006080526001600160a01b031660a052600160c081905260e05260006101005261008d565b60006020828403121561006f57600080fd5b81516001600160a01b038116811461008657600080fd5b9392505050565b60805160a05160c05160e051610100516108006100e560003960006103d3015260006103aa01526000610381015260008181607c015281816102570152610319015260008181610137015261015b01526108006000f3fe60806040526004361061005e5760003560e01c806354fd4d501161004357806354fd4d50146100df57806384411d6514610101578063d3e5792b1461012557600080fd5b80630d9019e11461006a5780633ccfd60b146100c857600080fd5b3661006557005b600080fd5b34801561007657600080fd5b5061009e7f000000000000000000000000000000000000000000000000000000000000000081565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020015b60405180910390f35b3480156100d457600080fd5b506100dd610159565b005b3480156100eb57600080fd5b506100f461037a565b6040516100bf91906105d4565b34801561010d57600080fd5b5061011760005481565b6040519081526020016100bf565b34801561013157600080fd5b506101177f000000000000000000000000000000000000000000000000000000000000000081565b7f0000000000000000000000000000000000000000000000000000000000000000471015610233576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152604a60248201527f4665655661756c743a207769746864726177616c20616d6f756e74206d75737460448201527f2062652067726561746572207468616e206d696e696d756d207769746864726160648201527f77616c20616d6f756e7400000000000000000000000000000000000000000000608482015260a40160405180910390fd5b600047905080600080828254610249919061061d565b9091555050604080518281527f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166020820152338183015290517fc8a211cc64b6ed1b50595a9fcb1932b6d1e5a6e8ef15b60e5b1f988ea9086bba9181900360600190a1604080516020810182526000815290517f548e0a5c0000000000000000000000000000000000000000000000000000000081527342000000000000000000000000000000000000109163548e0a5c918491610345917f0000000000000000000000000000000000000000000000000000000000000000916188b891600401610635565b6000604051808303818588803b15801561035e57600080fd5b505af1158015610372573d6000803e3d6000fd5b505050505050565b60606103a57f000000000000000000000000000000000000000000000000000000000000000061041d565b6103ce7f000000000000000000000000000000000000000000000000000000000000000061041d565b6103f77f000000000000000000000000000000000000000000000000000000000000000061041d565b60405160200161040993929190610679565b604051602081830303815290604052905090565b60608160000361046057505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b811561048a5780610474816106ef565b91506104839050600a83610756565b9150610464565b60008167ffffffffffffffff8111156104a5576104a561076a565b6040519080825280601f01601f1916602001820160405280156104cf576020820181803683370190505b5090505b8415610552576104e4600183610799565b91506104f1600a866107b0565b6104fc90603061061d565b60f81b818381518110610511576105116107c4565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535061054b600a86610756565b94506104d3565b949350505050565b60005b8381101561057557818101518382015260200161055d565b83811115610584576000848401525b50505050565b600081518084526105a281602086016020860161055a565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b6020815260006105e7602083018461058a565b9392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60008219821115610630576106306105ee565b500190565b73ffffffffffffffffffffffffffffffffffffffff8416815263ffffffff83166020820152606060408201526000610670606083018461058a565b95945050505050565b6000845161068b81846020890161055a565b80830190507f2e0000000000000000000000000000000000000000000000000000000000000080825285516106c7816001850160208a0161055a565b600192019182015283516106e281600284016020880161055a565b0160020195945050505050565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610720576107206105ee565b5060010190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b60008261076557610765610727565b500490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000828210156107ab576107ab6105ee565b500390565b6000826107bf576107bf610727565b500690565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea164736f6c634300080f000a0000000000000000000000002f44bd2a54ac3fb20cd7783cf94334069641dac9")
)

// ArsiaNetworkUpgradeTransactions returns the upgrade transactions for the Arsia network upgrade.
// The Arsia upgrade introduces operator fees and updates the L1 data fee calculation model.
func MantleArsiaNetworkUpgradeTransactions() ([]hexutil.Bytes, error) {
	upgradeTxns := make([]hexutil.Bytes, 0, 7)

	// 1. Deploy new L1Block implementation with operator fee support
	deployL1BlockTransaction, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaL1BlockSource.SourceHash(),
		From:                L1BlockArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 700_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                l1BlockArsiaDeploymentBytecode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployL1BlockTransaction)

	// 2. Deploy new GasPriceOracle implementation with Arsia fee calculation
	deployGasPriceOracle, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaGasPriceOracleSource.SourceHash(),
		From:                GasPriceOracleArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 1_800_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                gasPriceOracleArsiaDeploymentBytecode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployGasPriceOracle)

	// 3. Deploy new OperatorFeeVault implementation
	deployOperatorFeeVault, err := types.NewTx(&types.DepositTx{
		SourceHash:          deployArsiaOperatorFeeVaultSource.SourceHash(),
		From:                OperatorFeeVaultArsiaDeployerAddress,
		To:                  nil, // Contract deployment
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 500_000, // Estimated gas for deployment
		IsSystemTransaction: false,
		Data:                operatorFeeVaultArsiaDeploymentByteCode,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, deployOperatorFeeVault)

	// 4. Upgrade L1Block proxy to new implementation
	updateL1BlockProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaL1BlockProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.L1BlockAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaL1BlockAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateL1BlockProxy)

	// 5. Upgrade GasPriceOracle proxy to new implementation
	updateGasPriceOracleProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaGasPriceOracleProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.GasPriceOracleAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaGasPriceOracleAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateGasPriceOracleProxy)

	// 6. Upgrade OperatorFeeVault proxy to new implementation
	updateOperatorFeeVaultProxy, err := types.NewTx(&types.DepositTx{
		SourceHash:          updateArsiaOperatorFeeVaultProxySource.SourceHash(),
		From:                common.Address{}, // Zero address for proxy admin
		To:                  &predeploys.OperatorFeeVaultAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 50_000,
		IsSystemTransaction: false,
		Data:                upgradeToCalldata(arsiaOperatorFeeVaultAddress),
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, updateOperatorFeeVaultProxy)

	// 7. Enable Arsia mode in GasPriceOracle
	enableArsia, err := types.NewTx(&types.DepositTx{
		SourceHash:          enableArsiaSource.SourceHash(),
		From:                L1InfoDepositerAddress,
		To:                  &predeploys.GasPriceOracleAddr,
		Mint:                big.NewInt(0),
		Value:               big.NewInt(0),
		Gas:                 100_000,
		IsSystemTransaction: false,
		Data:                enableArsiaInput,
	}).MarshalBinary()

	if err != nil {
		return nil, err
	}

	upgradeTxns = append(upgradeTxns, enableArsia)

	return upgradeTxns, nil
}

func upgradeToCalldata(addr common.Address) []byte {
	buf := bytes.NewBuffer(make([]byte, 0, 4+20))
	if err := solabi.WriteSignature(buf, UpgradeToFuncBytes4); err != nil {
		panic(fmt.Errorf("failed to write upgradeTo signature data: %w", err))
	}
	if err := solabi.WriteAddress(buf, addr); err != nil {
		panic(fmt.Errorf("failed to write upgradeTo address data: %w", err))
	}
	return buf.Bytes()
}
